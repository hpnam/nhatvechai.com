<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Text-to-Speech Ti·∫øng Vi·ªát</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; max-width: 780px; margin: 24px auto; padding: 0 16px; }
    textarea { width: 100%; height: 110px; padding: 10px; font-size: 16px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin: 10px 0; }
    button { padding: 10px 14px; cursor: pointer; }
    select, input[type="range"] { width: 100%; }
    .box { border: 1px solid #ddd; border-radius: 10px; padding: 12px; }
    label { font-size: 14px; color: #333; }
    .col { flex: 1; min-width: 220px; }
    .value { font-variant-numeric: tabular-nums; }
    .note { color: #666; font-size: 14px; }
  </style>
</head>
<body>
  <h1>Ph√°t √¢m c√¢u ti·∫øng Vi·ªát (Web Speech API)</h1>

  <div class="box">
    <label for="text">N·ªôi dung:</label>
    <textarea id="text">Xin ch√†o! H√¥m nay b·∫°n th·∫ø n√†o?</textarea>

    <div class="row">
      <div class="col">
        <label for="voice">Gi·ªçng (Voice):</label>
        <select id="voice"></select>
      </div>
      <div class="col">
        <label for="rate">T·ªëc ƒë·ªô (Rate): <span class="value" id="rateVal">1.0</span></label>
        <input id="rate" type="range" min="0.5" max="2" step="0.1" value="1.0" />
      </div>
      <div class="col">
        <label for="pitch">Cao ƒë·ªô (Pitch): <span class="value" id="pitchVal">1.0</span></label>
        <input id="pitch" type="range" min="0" max="2" step="0.1" value="1.0" />
      </div>
    </div>

    <div class="row">
      <button id="speak">üîä Ph√°t</button>
      <button id="pause">‚è∏ T·∫°m d·ª´ng</button>
      <button id="resume">‚ñ∂Ô∏è Ti·∫øp t·ª•c</button>
      <button id="stop">‚èπ D·ª´ng</button>
    </div>

    <p class="note">
      M·∫πo: N·∫øu kh√¥ng th·∫•y gi·ªçng ti·∫øng Vi·ªát, h√£y th·ª≠ Edge/Chrome tr√™n Windows, ho·∫∑c c√†i th√™m gi·ªçng ‚ÄúVietnamese‚Äù trong c√†i ƒë·∫∑t h·ªá ƒëi·ªÅu h√†nh.
    </p>
  </div>

  <script>
    // Ki·ªÉm tra h·ªó tr·ª£
    if (!("speechSynthesis" in window) || typeof SpeechSynthesisUtterance === "undefined") {
      alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Web Speech API (speechSynthesis).");
    }

    const synth = window.speechSynthesis;

    const textEl = document.getElementById("text");
    const voiceEl = document.getElementById("voice");
    const rateEl = document.getElementById("rate");
    const pitchEl = document.getElementById("pitch");
    const rateValEl = document.getElementById("rateVal");
    const pitchValEl = document.getElementById("pitchVal");

    const speakBtn = document.getElementById("speak");
    const pauseBtn = document.getElementById("pause");
    const resumeBtn = document.getElementById("resume");
    const stopBtn = document.getElementById("stop");

    let voices = [];
    let currentUtterance = null;

    function isVietnameseVoice(v) {
      // Nhi·ªÅu h·ªá th·ªëng ƒë·∫∑t lang l√† "vi-VN"
      // M·ªôt s·ªë voice name c√≥ ch·ªØ "Vietnam" / "Ti·∫øng Vi·ªát"
      const lang = (v.lang || "").toLowerCase();
      const name = (v.name || "").toLowerCase();
      return lang.startsWith("vi") || name.includes("vietnam") || name.includes("ti·∫øng vi·ªát") || name.includes("tieng viet");
    }

    function loadVoices() {
      voices = synth.getVoices();

      // S·∫Øp x·∫øp: ∆∞u ti√™n voice ti·∫øng Vi·ªát l√™n ƒë·∫ßu, c√≤n l·∫°i ph√≠a sau
      const preferred = voices.filter(isVietnameseVoice);
      const others = voices.filter(v => !isVietnameseVoice(v));
      const sorted = [...preferred, ...others];

      voiceEl.innerHTML = "";
      sorted.forEach((v, i) => {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = `${v.name} (${v.lang})${v.default ? " ‚Äî default" : ""}`;
        voiceEl.appendChild(opt);
      });

      // N·∫øu c√≥ ti·∫øng Vi·ªát, auto ch·ªçn c√°i ƒë·∫ßu ti√™n trong nh√≥m preferred
      if (preferred.length > 0) {
        voiceEl.value = "0";
      }
    }

    // M·ªôt s·ªë tr√¨nh duy·ªát n·∫°p voice b·∫•t ƒë·ªìng b·ªô
    loadVoices();
    if (typeof synth.onvoiceschanged !== "undefined") {
      synth.onvoiceschanged = loadVoices;
    }

    function stopSpeaking() {
      // cancel() d·ª´ng to√†n b·ªô h√†ng ƒë·ª£i
      synth.cancel();
      currentUtterance = null;
    }

    function speak(text) {
      if (!text.trim()) return;

      // N·∫øu ƒëang n√≥i, d·ª´ng r·ªìi n√≥i l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t voice/rate/pitch
      stopSpeaking();

      const u = new SpeechSynthesisUtterance(text);
      currentUtterance = u;

      // √Åp voice theo select (d·ª±a tr√™n danh s√°ch ƒë√£ sort)
      const selectedIndex = Number(voiceEl.value);
      const sorted = Array.from(voiceEl.options).map((_, idx) => idx); // ch·ªâ ƒë·ªÉ gi·ªØ logic
      // Ta rebuild theo c√πng th·ª© t·ª± ƒë√£ render
      const preferred = voices.filter(isVietnameseVoice);
      const others = voices.filter(v => !isVietnameseVoice(v));
      const orderedVoices = [...preferred, ...others];

      u.voice = orderedVoices[selectedIndex] || null;

      u.lang = (u.voice && u.voice.lang) ? u.voice.lang : "vi-VN";
      u.rate = Number(rateEl.value);
      u.pitch = Number(pitchEl.value);

      u.onend = () => { currentUtterance = null; };
      u.onerror = (e) => {
        console.error("TTS error:", e);
        currentUtterance = null;
      };

      synth.speak(u);
    }

    // UI bindings
    rateEl.addEventListener("input", () => rateValEl.textContent = Number(rateEl.value).toFixed(1));
    pitchEl.addEventListener("input", () => pitchValEl.textContent = Number(pitchEl.value).toFixed(1));

    speakBtn.addEventListener("click", () => speak(textEl.value));
    pauseBtn.addEventListener("click", () => synth.pause());
    resumeBtn.addEventListener("click", () => synth.resume());
    stopBtn.addEventListener("click", () => stopSpeaking());

    // Hi·ªÉn th·ªã gi√° tr·ªã ban ƒë·∫ßu
    rateValEl.textContent = Number(rateEl.value).toFixed(1);
    pitchValEl.textContent = Number(pitchEl.value).toFixed(1);
  </script>
</body>
</html>
